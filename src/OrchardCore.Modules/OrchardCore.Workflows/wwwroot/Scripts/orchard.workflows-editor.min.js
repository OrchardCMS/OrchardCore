var applyFilter=function(t,e){var i=$(".modal-activities").data("activity-type");t=t||$(".activity-picker-categories .nav-link.active").attr("href").substr(1),e=e||$(".modal-activities input[type=search]").val();var a=$(".activity.card").show();a.filter((function(t,e){return $(e).data("activity-type")!=i})).hide(),e.length>0?a.filter((function(t,i){return $(i).find(".card-title").text().toLowerCase().indexOf(e.toLowerCase())<0&&e&&e.length>0})).hide():a.filter((function(e,i){return $(i).data("category").toLowerCase()!=t.toLowerCase()&&"all"!=t.toLowerCase()})).hide(),$(".activity-picker-categories [data-category]").each((function(t,e){var a=$(e),o=a.data("category");0==$(".activity.card[data-category='"+o+"'][data-activity-type='"+i+"']").length?a.hide():a.show()}))};$((function(){$(".activity-picker-categories").on("click",".nav-link",(function(t){applyFilter($(t.target).attr("href").substr(1),null)})),$(".modal-activities input[type=search]").on("keyup",(function(t){applyFilter(null,$(t.target).val())})),$("#activity-picker").on("show.bs.modal",(function(t){var e=$(t.relatedTarget),i=e.data("picker-title"),a=e.data("activity-type"),o=$(this);o.find('[href="#all"]').click(),o.find(".modal-title").text(i),o.data("activity-type",a),applyFilter(null,null)}))})),$((function(){var t=function(){var t=$("[data-workflow-type-id]").data("workflow-type-id"),e=$("[data-activity-id]").data("activity-id"),i=$("#token-lifespan").val(),a=$("[data-generate-url]").data("generate-url")+"?workflowTypeId="+t+"&activityId="+e+"&tokenLifeSpan="+i,o=$("[data-antiforgery-header-name]").data("antiforgery-header-name"),n=$("[data-antiforgery-token]").data("antiforgery-token"),r={};r[o]=n,$.post({url:a,headers:r}).done((function(t){$("#workflow-url-text").val(t)}))};$("#generate-url-button").on("click",(function(e){t()})),""==$("#workflow-url-text").val()&&t()}));var WorkflowCanvas=function(t,e){var i=this;this.container=t,this.workflowType=e,this.minCanvasHeight=400,this.getActivityElements=function(){return $(i.container).find(".activity")},this.getDefaults=function(){return{Anchor:"Continuous",DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"}],Endpoints:[["Dot",{radius:7}],["Blank"]],ConnectionOverlays:[["Arrow",{width:12,length:12,location:-5}]],ConnectorZIndex:5}},this.createJsPlumbInstance=function(){return jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:i.container})},this.getEndpointColor=function(t){return t.isBlocking||t.isStart?"#7ab02c":t.isEvent?"#3a8acd":"#7ab02c"},this.getSourceEndpointOptions=function(t,e){var a=i.getEndpointColor(t);return{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:a,fill:a,radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},connectorOverlays:[["Label",{location:[3,-1.5],cssClass:"endpointSourceLabel"}]],dragOptions:{},uuid:t.id+"-"+e.name,parameters:{outcome:e}}},this.getActivity=function(t,e){return void 0===e&&(e=null),e||(e=this.workflowType.activities),$.grep(e,(function(e){return e.id===t}))[0]},this.updateConnections=function(t){for(var e=i.workflowType.id,a=0,o=i.workflowType.transitions;a<o.length;a++){var n=o[a],r=n.sourceActivityId+"-"+n.sourceOutcomeName,c=t.getEndpoint(r),s="activity-"+e+"-"+n.destinationActivityId;t.connect({source:c,target:s})}},this.updateCanvasHeight=function(){for(var t=$(this.container),e=0,i=0,a=0,o=t.find(".activity").toArray();a<o.length;a++){var n=o[a],r=$(n),c=r.position().top;c>e&&(e=c,i=r.height())}var s=e+i;s-(e+i)<=100&&(s+=100),t.height(Math.max(this.minCanvasHeight,s))}},__extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function a(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}(),WorkflowEditor=function(t){function e(e,i,a,o,n){var r=t.call(this,e,i)||this;r.container=e,r.workflowType=i,r.deleteActivityPrompt=a,r.localId=o,r.getState=function(){for(var t=$(r.container).find(".activity"),e={id:r.workflowType.id,activities:[],transitions:[],removedActivities:r.workflowType.removedActivities},i=0;i<t.length;i++){var a=$(t[i]),o=a.data("activity-id"),n=a.data("activity-start"),c="Event"===a.data("activity-type"),s=a.position(),l=r.getActivity(o);e.activities.push({id:o,isStart:n,isEvent:c,outcomes:l.outcomes,x:s.left,y:s.top})}var d=r.jsPlumbInstance.getConnections();for(i=0;i<d.length;i++){var u=d[i],v=u.endpoints[0].getParameters().outcome.name,f=$(u.source).data("activity-id"),p=$(u.target).data("activity-id");e.transitions.push({sourceActivityId:f,destinationActivityId:p,sourceOutcomeName:v})}return e},r.serialize=function(){var t=r.getState();return JSON.stringify(t)},r.saveLocalState=function(){sessionStorage[r.localId]=r.serialize()},r.loadLocalState=function(){return JSON.parse(sessionStorage[r.localId])};var c=r;return jsPlumb.ready((function(){jsPlumb.importDefaults(r.getDefaults());var t=r.createJsPlumbInstance();t.bind("connection",(function(t,e){var i=t.connection,a=i.getParameters().outcome;i.getOverlay("label").setLabel(a.displayName)}));var i=r.getActivityElements();t.batch((function(){var e=r.workflowType;r.workflowType.id;if(n){var a=r.loadLocalState();a&&(r.workflowType=a)}i.each((function(i,a){var o=$(a),c=o.data("activity-id");if(r.workflowType.removedActivities.indexOf(c)>-1)o.remove();else{var s=r.getActivity(c),l=r.getActivity(c,e.activities);if(n)if(null==s)s=l,r.workflowType.activities.push(s),s.x=50,s.y=50;else(function(t,e){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++){var a=t[i],o=e[i];if(a.name!=o.displayName||a.displayName!=o.displayName)return!1}return!0})(s.outcomes,l.outcomes)||(s.outcomes=l.outcomes),o.css({left:s.x,top:s.y}).toggleClass("activity-start",s.isStart).data("activity-start",s.isStart);t.draggable(a,{grid:[10,10],containment:!0,start:function(t){r.dragStart={left:t.e.screenX,top:t.e.screenY}},stop:function(t){r.hasDragged=r.dragStart.left!=t.e.screenX||r.dragStart.top!=t.e.screenY,r.updateCanvasHeight()}}),t.makeTarget(a,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(var d=0,u=s.outcomes;d<u.length;d++){var v=u[d],f=r.getSourceEndpointOptions(s,v);t.addEndpoint(a,{connectorOverlays:[["Label",{label:v.displayName,cssClass:"connection-label"}]]},f)}}})),r.updateConnections(t),(i=r.getActivityElements()).show(),r.updateCanvasHeight()})),i.popover({trigger:"manual",html:!0,content:function(){var e=$(this),i=e.find(".activity-commands").clone().show(),a=i.find(".activity-start-action"),o=!0===e.data("activity-start"),n=e.data("activity-id");return a.attr("aria-pressed",e.data("activity-start")),a.toggleClass("active",o),i.on("click",".activity-start-action",(function(t){t.preventDefault();var i=$(t.currentTarget);i.button("toggle");var a=i.is(".active");e.data("activity-start",a),e.toggleClass("activity-start",a)})),i.on("click",".activity-delete-action",(function(i){i.preventDefault(),c.workflowType.removedActivities.push(n),t.remove(e),e.popover("dispose")})),i.on("click","[data-persist-workflow]",(function(t){c.saveLocalState()})),i.get(0)}}),$(e).on("click",".activity",(function(t){r.hasDragged?r.hasDragged=!1:(r.isPopoverVisible&&i.popover("hide"),$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",(function(t){t.stopPropagation()})),t.stopPropagation(),r.isPopoverVisible=!0)})),$(e).on("dblclick",".activity",(function(t){var e=$(t.currentTarget);e.data("activity-has-editor")&&(r.saveLocalState(),e.find(".activity-edit-action").get(0).click())})),$("body").on("click",(function(t){i.popover("hide"),r.isPopoverVisible=!1})),$("body").on("click","[data-persist-workflow]",(function(t){r.saveLocalState()})),r.jsPlumbInstance=t})),r}return __extends(e,t),e}(WorkflowCanvas);$.fn.workflowEditor=function(){return this.each((function(t,e){var i=$(e),a=i.data("workflow-type"),o=i.data("workflow-delete-activity-prompt"),n=i.data("workflow-local-id"),r=i.data("workflow-load-local-state");a.removedActivities=a.removedActivities||[],i.data("workflowEditor",new WorkflowEditor(e,a,o,n,r))})),this},$(document).ready((function(){var t=$(".workflow-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",(function(e,i){var a=t.serialize();$("#workflowStateInput").val(a)}))}));
