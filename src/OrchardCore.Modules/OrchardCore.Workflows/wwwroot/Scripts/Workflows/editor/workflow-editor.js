!function(t,e,o,i){var a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n="function"==typeof a[i]&&a[i],r=n.cache||{},s="undefined"!=typeof module&&"function"==typeof module.require&&module.require.bind(module);function c(e,o){if(!r[e]){if(!t[e]){var l="function"==typeof a[i]&&a[i];if(!o&&l)return l(e,!0);if(n)return n(e,!0);if(s&&"string"==typeof e)return s(e);var d=new Error("Cannot find module '"+e+"'");throw d.code="MODULE_NOT_FOUND",d}f.resolve=function(o){var i=t[e][1][o];return null!=i?i:o},f.cache={};var u=r[e]=new c.Module(e);t[e][0].call(u.exports,f,u,u.exports,a)}return r[e].exports;function f(t){var e=f.resolve(t);return!1===e?{}:c(e)}}c.isParcelRequire=!0,c.Module=function(t){this.id=t,this.bundle=c,this.exports={}},c.modules=t,c.cache=r,c.parent=n,c.register=function(e,o){t[e]=[function(t,e){e.exports=o},{}]},Object.defineProperty(c,"root",{get:function(){return a[i]}}),a[i]=c;for(var l=0;l<e.length;l++)c(e[l]);if(o){var d=c(o);"object"==typeof exports&&"undefined"!=typeof module?module.exports=d:"function"==typeof define&&define.amd&&define(function(){return d})}}({"1cTtB":[function(t,e,o,i){var a=t("@parcel/transformer-js/src/esmodule-helpers.js"),n=(t("./workflow-models"),t("./activity-picker"),t("./workflow-url-generator"),t("./workflow-canvas")),r=a.interopDefault(n);class s extends r.default{constructor(t,e,o,i,a){super(t,e),this.container=t,this.workflowType=e,this.deleteActivityPrompt=o,this.localId=i,this.getState=()=>{const t=$(this.container).find(".activity"),e={id:this.workflowType.id,activities:[],transitions:[],removedActivities:this.workflowType.removedActivities};for(let o=0;o<t.length;o++){const i=$(t[o]),a=i.data("activity-id"),n=i.data("activity-start"),r="Event"===i.data("activity-type"),s=i.position(),c=this.getActivity(a);e.activities.push({id:a,isStart:n,isEvent:r,outcomes:c.outcomes,x:s.left,y:s.top})}const o=this.jsPlumbInstance.getConnections();for(let t=0;t<o.length;t++){var i=o[t],a=i.endpoints[0].getParameters().outcome.name,n=$(i.source).data("activity-id"),r=$(i.target).data("activity-id");e.transitions.push({sourceActivityId:n,destinationActivityId:r,sourceOutcomeName:a})}return e},this.serialize=()=>{const t=this.getState();return JSON.stringify(t)},this.saveLocalState=()=>{sessionStorage[this.localId]=this.serialize()},this.loadLocalState=()=>JSON.parse(sessionStorage[this.localId]);const n=this;jsPlumb.ready(()=>{jsPlumb.importDefaults(this.getDefaults());const e=this.createJsPlumbInstance();e.bind("connection",function(t,e){const o=t.connection,i=o.getParameters().outcome;o.getOverlay("label").setLabel(i.displayName);const a=t.sourceEndpoint;a&&a.hideOverlay&&a.hideOverlay("outcome-label")}),e.bind("connectionDetached",function(t,e){const o=t.sourceEndpoint;o&&o.connections&&0===o.connections.length&&o.showOverlay&&o.showOverlay("outcome-label")});let o=this.getActivityElements();e.batch(()=>{var t=this.workflowType;this.workflowType.id;if(a){const t=this.loadLocalState();t&&(this.workflowType=t)}o.each((o,i)=>{const n=$(i),r=n.data("activity-id");if(this.workflowType.removedActivities.indexOf(r)>-1)return void n.remove();let s=this.getActivity(r);const c=this.getActivity(r,t.activities);if(a)if(null==s)s=c,this.workflowType.activities.push(s),s.x=50,s.y=50;else{(function(t,e){if(t.length!=e.length)return!1;for(let o=0;o<t.length;o++){const i=t[o],a=e[o];if(i.name!=a.name||i.displayName!=a.displayName)return!1}return!0})(s.outcomes,c.outcomes)||(s.outcomes=c.outcomes),n.css({left:s.x,top:s.y}).toggleClass("activity-start",s.isStart).data("activity-start",s.isStart)}e.draggable(i,{grid:[10,10],containment:!0,start:t=>{this.dragStart={left:t.e.screenX,top:t.e.screenY}},stop:t=>{this.hasDragged=this.dragStart.left!=t.e.screenX||this.dragStart.top!=t.e.screenY,this.updateCanvasHeight()}}),e.makeTarget(i,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(let t of s.outcomes){const o=this.getSourceEndpointOptions(s,t);var l=e.addEndpoint(i,{connectorOverlays:[["Label",{label:t.displayName,cssClass:"connection-label"}]]},o);this.endpointMap.push({endpoint:l,activityElement:i}),l.canvas&&l.canvas.setAttribute("title",t.displayName)}}),this.updateConnections(e),o=this.getActivityElements(),o.show(),this.updateCanvasHeight()}),this.orientOutcomeLabels(),o.each((t,o)=>{var i=$(o);i.popover({trigger:"manual",html:!0,content:()=>{const t=i.find(".activity-commands").clone(),o=t.find(".activity-start-action"),a=!0===i.data("activity-start"),r=i.data("activity-id");return o.attr("aria-pressed",i.data("activity-start")),o.toggleClass("active",a),t.on("click",".activity-start-action",t=>{t.preventDefault();const e=$(t.currentTarget).is(".active");i.data("activity-start",e),i.toggleClass("activity-start",e)}),t.on("click",".activity-delete-action",t=>{t.preventDefault(),n.workflowType.removedActivities.push(r),e.remove(i),i.popover("dispose")}),t.on("click","[data-persist-workflow]",t=>{n.saveLocalState()}),t.get(0)}})}),$(t).on("click",".activity",t=>{if(this.hasDragged)return void(this.hasDragged=!1);this.isPopoverVisible&&o.popover("hide");$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",t=>{t.stopPropagation()}),t.stopPropagation(),this.isPopoverVisible=!0}),$(t).on("dblclick",".activity",t=>{const e=$(t.currentTarget);e.data("activity-has-editor")&&(this.saveLocalState(),e.find(".activity-edit-action").get(0).click())}),$("body").on("click",t=>{o.popover("hide"),this.isPopoverVisible=!1}),$("body").on("click","[data-persist-workflow]",t=>{this.saveLocalState()}),this.jsPlumbInstance=e})}}$.fn.workflowEditor=function(){return this.each((t,e)=>{var o=$(e),i=o.data("workflow-type"),a=o.data("workflow-delete-activity-prompt"),n=o.data("workflow-local-id"),r=o.data("workflow-load-local-state");i.removedActivities=i.removedActivities||[],o.data("workflowEditor",new s(e,i,a,n,r))}),this},$(document).ready(function(){const t=$(".workflow-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",(e,o)=>{const i=t.serialize();$("#workflowStateInput").val(i)})})},{"./workflow-models":"aM2tG","./activity-picker":"40nzd","./workflow-url-generator":"f5jsY","./workflow-canvas":"cHBDw","@parcel/transformer-js/src/esmodule-helpers.js":"dGByK"}],aM2tG:[function(t,e,o,i){},{}],"40nzd":[function(t,e,o,i){var a=function(t,e){const o=$(".modal-activities").data("activity-type");t=t||$(".activity-picker-categories .nav-link.active").attr("href").substr(1),e=e||$(".modal-activities input[type=search]").val();const i=$(".activity.col").show();i.filter((t,e)=>$(e).data("activity-type")!=o).hide(),e.length>0?i.filter((t,o)=>$(o).find(".card-title").text().toLowerCase().indexOf(e.toLowerCase())<0&&e&&e.length>0).hide():i.filter((e,o)=>$(o).data("category").toLowerCase()!=t.toLowerCase()&&"all"!=t.toLowerCase()).hide(),$(".activity-picker-categories [data-category]").each((t,e)=>{const i=$(e),a=i.data("category");0==$(`.activity.col[data-category='${a}'][data-activity-type='${o}']`).length?i.hide():i.show()})};$(()=>{$(".activity-picker-categories").on("click",".nav-link",t=>{a($(t.target).attr("href").substr(1),null)}),$(".modal-activities input[type=search]").on("keyup",t=>{a(null,$(t.target).val())}),$("#activity-picker").on("show.bs.modal",function(t){var e=$(t.relatedTarget),o=e.data("picker-title"),i=e.data("activity-type"),n=$(this);n.find('[href="#all"]').click(),n.find(".modal-title").text(o),n.data("activity-type",i),a(null,null)})})},{}],f5jsY:[function(t,e,o,i){$(()=>{const t=function(){const t=$("[data-workflow-type-id]").data("workflow-type-id"),e=$("[data-activity-id]").data("activity-id");var o=$("#token-lifespan").val();const i=$("[data-generate-url]").data("generate-url")+`?workflowTypeId=${t}&activityId=${e}&tokenLifeSpan=${o}`,a=$("[data-antiforgery-header-name]").data("antiforgery-header-name"),n=$("[data-antiforgery-token]").data("antiforgery-token"),r={};r[a]=n,$.post({url:i,headers:r}).done(t=>{$("#workflow-url-text").val(t)})};$("#generate-url-button").on("click",e=>{t()}),""==$("#workflow-url-text").val()&&t()})},{}],cHBDw:[function(t,e,o,i){t("@parcel/transformer-js/src/esmodule-helpers.js").defineInteropFlag(o);t("./workflow-models");o.default=class{constructor(t,e){this.container=t,this.workflowType=e,this.minCanvasHeight=400,this.endpointMap=[],this.getActivityElements=()=>$(this.container).find(".activity"),this.getDefaults=()=>({Anchor:"Continuous",DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"}],Endpoints:[["Dot",{radius:7}],["Blank"]],ConnectionOverlays:[["Arrow",{width:12,length:12,location:-5}]],ConnectorZIndex:5}),this.createJsPlumbInstance=()=>jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:this.container}),this.getEndpointColor=t=>t.isBlocking||t.isStart?"#7ab02c":t.isEvent?"#3a8acd":"#7ab02c",this.getSourceEndpointOptions=(t,e)=>{const o=this.getEndpointColor(t);return{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:o,fill:o,radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},connectorOverlays:[["Label",{location:[3,-1.5],cssClass:"endpointSourceLabel"}]],overlays:[["Label",{label:e.displayName,cssClass:"outcome-label",id:"outcome-label",location:[0,0]}]],dragOptions:{},uuid:`${t.id}-${e.name}`,parameters:{outcome:e}}},this.getActivity=function(t,e=null){return e||(e=this.workflowType.activities),$.grep(e,e=>e.id===t)[0]},this.updateConnections=t=>{var e=this.workflowType.id;for(let o of this.workflowType.transitions){const i=`${o.sourceActivityId}-${o.sourceOutcomeName}`,a=t.getEndpoint(i),n=`activity-${e}-${o.destinationActivityId}`;t.connect({source:a,target:n})}},this.updateCanvasHeight=function(){const t=$(this.container),e=t.find(".activity");let o=0,i=0;for(let t of e.toArray()){const e=$(t),a=e.position().top;a>o&&(o=a,i=e.height())}let a=o+i;a-(o+i)<=100&&(a+=100),t.height(Math.max(this.minCanvasHeight,a))},this.orientOutcomeLabels=()=>{for(const{endpoint:t,activityElement:e}of this.endpointMap){const o=t.getOverlay?t.getOverlay("outcome-label"):null;if(!o)continue;const i=o.getElement?o.getElement():o.canvas;if(!i)continue;const a=t.canvas;if(!a)continue;const n=e.getBoundingClientRect(),r=a.getBoundingClientRect(),s=n.left+n.width/2,c=n.top+n.height/2,l=r.left+r.width/2-s,d=r.top+r.height/2-c;let u;u=(n.width>0?Math.abs(l)/(n.width/2):0)>(n.height>0?Math.abs(d)/(n.height/2):0)?l>0?"right":"left":d>0?"bottom":"top";const f=$(i);let h=f.outerWidth()/2;if(0===h){const t=i.style.display;i.style.display="block",h=f.outerWidth()/2,i.style.display=t}const p=i.style.transform||"",v=p&&"none"!==p?p+" ":"";switch(u){case"bottom":f.css({transform:v+`translateY(${h}px) rotate(90deg)`,"transform-origin":"center center"});break;case"top":f.css({transform:v+`translateY(-${h}px) rotate(-90deg)`,"transform-origin":"center center"});break;case"left":f.css({transform:v+`translateX(-${h}px)`});break;case"right":f.css({transform:v+`translateX(${h}px)`})}}}}}},{"./workflow-models":"aM2tG","@parcel/transformer-js/src/esmodule-helpers.js":"dGByK"}],dGByK:[function(t,e,o,i){o.interopDefault=function(t){return t&&t.__esModule?t:{default:t}},o.defineInteropFlag=function(t){Object.defineProperty(t,"__esModule",{value:!0})},o.exportAll=function(t,e){return Object.keys(t).forEach(function(o){"default"===o||"__esModule"===o||Object.prototype.hasOwnProperty.call(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[o]}})}),e},o.export=function(t,e,o){Object.defineProperty(t,e,{enumerable:!0,get:o})}},{}]},["1cTtB"],"1cTtB","parcelRequire94c2");
//# sourceMappingURL=workflow-editor.js.map
