using System.Security.Claims;
using Microsoft.AspNetCore.Http;

namespace OrchardCore.Environment.Cache.CacheContextProviders;

public class RolesCacheContextProvider : ICacheContextProvider
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public RolesCacheContextProvider(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public Task PopulateContextEntriesAsync(IEnumerable<string> contexts, List<CacheContextEntry> entries)
    {
        if (contexts.Any(ctx => string.Equals(ctx, "user.roles", StringComparison.OrdinalIgnoreCase)))
        {
            var user = _httpContextAccessor.HttpContext.User;
            if (user.Identity.IsAuthenticated)
            {
                var roleClaims = user.Claims.Where(x => x.Type == ClaimTypes.Role);
                foreach (var roleClaim in roleClaims)
                {
                    entries.Add(new CacheContextEntry("user.roles", roleClaim.Value));
                }

                return Task.CompletedTask;
            }
        }

        return Task.CompletedTask;
    }
}
